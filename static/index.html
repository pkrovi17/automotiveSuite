<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vehicle Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity=""
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity=""
    crossorigin=""
  ></script>

  <style>
    :root { --bg:#0e1117; --fg:#e6edf3; --muted:#9aa4ad; --card:#161b22; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    header { padding:12px 16px; background:#0b0e14; border-bottom:1px solid #222; display:flex; align-items:center; gap:12px;}
    h1 { font-size:16px; margin:0; }
    .container { display:grid; grid-template-columns: 2fr 1fr; gap:12px; padding:12px; height: calc(100vh - 58px); }
    #map { width:100%; height:100%; border-radius:8px; }
    .card { background:var(--card); border:1px solid #222; border-radius:8px; overflow:hidden; }
    .card h2 { font-size:14px; margin:0; padding:10px 12px; border-bottom:1px solid #222; color:var(--muted); }
    table { width:100%; border-collapse: collapse; }
    th, td { font-size:13px; padding:8px 10px; border-bottom:1px solid #252a33; }
    th { text-align:left; color:var(--muted); background:#131820; position: sticky; top:0; }
    .speed-badge { padding:2px 6px; border-radius:12px; font-weight:600; }
    .spd-low { background:#1b5e20; }
    .spd-med { background:#7f6000; }
    .spd-high{ background:#7f1d1d; }
    .pill { padding:2px 6px; border-radius:12px; background:#1f2937; color:#cbd5e1; font-size:12px;}
    .footer { color: var(--muted); font-size:12px; padding:8px 12px; background:#0b0e14; border-top:1px solid #222;}
  </style>
</head>
<body>
  <header>
    <h1>Vehicle Dashboard</h1>
    <div id="status" class="pill">connecting…</div>
  </header>

  <div class="container">
    <div class="card">
      <h2>Map</h2>
      <div id="map"></div>
    </div>

    <div class="card" style="display:flex; flex-direction:column;">
      <h2>Live Telemetry</h2>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Device</th>
              <th>Speed</th>
              <th>Movement</th>
              <th>State</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>Last Seen</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="footer">
        Speed color: <span class="speed-badge spd-low">≤30</span>
        <span class="speed-badge spd-med">31–60</span>
        <span class="speed-badge spd-high">&gt;60</span> (km/h)
      </div>
    </div>
  </div>

  <script>
    // ---------- Leaflet map ----------
    const map = L.map('map', { zoomControl: true });
    // Default center; will auto-fit to markers as they arrive
    map.setView([17.4, 78.5], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Keep markers by device id
    const markers = new Map();

    function speedClass(spd) {
      if (spd == null || isNaN(spd)) return "spd-low";
      if (spd <= 30) return "spd-low";
      if (spd <= 60) return "spd-med";
      return "spd-high";
    }

    function markerColor(spd) {
      // Simple colored circle
      if (spd == null || isNaN(spd)) return "#94a3b8";
      if (spd <= 30) return "#22c55e";
      if (spd <= 60) return "#eab308";
      return "#ef4444";
    }

    function upsertMarker(rec) {
      const { device_id, latitude, longitude, speed, movement, state, timestamp } = rec;
      const key = device_id;
      const color = markerColor(speed);
      const icon = L.divIcon({
        className: "",
        html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow:0 0 6px rgba(0,0,0,.5)"></div>`,
        iconSize: [14, 14],
        iconAnchor: [7, 7],
      });

      let m = markers.get(key);
      if (!m) {
        m = L.marker([latitude, longitude], { icon }).addTo(map);
        markers.set(key, m);
      } else {
        m.setLatLng([latitude, longitude]);
        m.setIcon(icon);
      }
      const spdStr = (speed == null || isNaN(speed)) ? "—" : `${Math.round(speed)} km/h`;
      m.bindPopup(
        `<b>Device:</b> ${device_id}<br/>
         <b>Speed:</b> ${spdStr}<br/>
         <b>Movement:</b> ${movement ?? "—"}<br/>
         <b>State:</b> ${state ?? "—"}<br/>
         <b>Time:</b> ${timestamp}`
      );

      // Fit bounds to all markers after first few updates
      const latlngs = Array.from(markers.values()).map(mm => mm.getLatLng());
      if (latlngs.length === 1) map.setView(latlngs[0], 13);
      else if (latlngs.length > 1) {
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    // ---------- Table ----------
    const rows = document.getElementById("rows");

    function renderTable(devices) {
      // Sort by device id
      devices.sort((a,b) => (a.device_id || "").localeCompare(b.device_id || ""));
      rows.innerHTML = "";
      for (const d of devices) {
        const spdStr = (d.speed == null || isNaN(d.speed)) ? "—" : `${Math.round(d.speed)} km/h`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.device_id ?? "—"}</td>
          <td><span class="speed-badge ${speedClass(d.speed)}">${spdStr}</span></td>
          <td>${d.movement ?? "—"}</td>
          <td>${d.state ?? "—"}</td>
          <td>${Number(d.latitude).toFixed(6)}</td>
          <td>${Number(d.longitude).toFixed(6)}</td>
          <td>${d.timestamp ?? "—"}</td>
        `;
        rows.appendChild(tr);
      }
    }

    // ---------- WebSocket ----------
    const status = document.getElementById("status");
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${proto}://${location.host}/ws`);

    ws.onopen = () => status.textContent = "live";
    ws.onclose = () => status.textContent = "disconnected";
    ws.onerror = () => status.textContent = "error";

    const devices = new Map(); // device_id -> record

    function upsertDevice(rec) {
      devices.set(rec.device_id, rec);
      renderTable(Array.from(devices.values()));
      upsertMarker(rec);
    }

    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === "snapshot" && Array.isArray(msg.data)) {
          devices.clear();
          for (const r of msg.data) devices.set(r.device_id, r);
          renderTable(Array.from(devices.values()));
          for (const r of devices.values()) upsertMarker(r);
        } else if (msg.type === "update" && msg.data) {
          upsertDevice(msg.data);
        }
      } catch (e) {
        console.error("bad message", e);
      }
    };
  </script>
</body>
</html>
