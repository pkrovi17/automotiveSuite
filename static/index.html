<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vehicle Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root { --bg:#0e1117; --fg:#e6edf3; --muted:#9aa4ad; --card:#161b22; --border:#222; --chip:#1f2937; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg);
           font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; }
    header { padding:12px 16px; background:#0b0e14; border-bottom:1px solid var(--border);
             display:flex; align-items:center; gap:12px; }
    h1 { font-size:16px; margin:0; }
    .pill { padding:2px 8px; border-radius:12px; background:var(--chip); color:#cbd5e1; font-size:12px; }
    .container { display:grid; grid-template-columns: 2fr 1.6fr; gap:12px; padding:12px; height: calc(100vh - 58px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
    .card h2 { font-size:14px; margin:0; padding:10px 12px; border-bottom:1px solid var(--border); color:var(--muted); }
    #map { width:100%; height:100%; }
    .rightcol { display:grid; grid-template-rows: auto 1fr; gap:12px; min-height:0; }
    .section-body { padding:12px; overflow:auto; }

    /* Cards grid */
    #cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
    .devcard { border:1px solid var(--border); border-radius:10px; background:#0f131a; padding:12px; display:grid; gap:10px; }
    .devhead { display:flex; justify-content:space-between; align-items:center; }
    .devtitle { font-weight:700; font-size:14px; }
    .centerbtn { background:#101826; border:1px solid #2a3340; color:#cbd5e1; border-radius:8px; font-size:12px;
                 padding:6px 8px; cursor:pointer; }
    .centerbtn:hover { filter:brightness(1.1); }

    .stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .stat { background:#131820; border:1px solid var(--border); border-radius:8px; padding:10px; min-height:70px; display:grid; gap:6px; }
    .label { color:var(--muted); font-size:11px; }
    .value { font-weight:800; font-size:18px; }
    .sub { font-size:12px; color:#b3beca; word-break:break-word; }

    .badge { padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; width:fit-content; }
    .spd-low { background:#1b5e20; }
    .spd-med { background:#7f6000; }
    .spd-high{ background:#7f1d1d; }
    .mv-accel { background:#1e3a8a; }
    .mv-decel { background:#7c2d12; }
    .mv-const { background:#374151; }
    .state-move { background:#0f5132; }
    .state-rest { background:#5a1a1a; }
    .coords { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .coords a { color:#93c5fd; text-decoration:none; font-size:12px; }
    .coords a:hover { text-decoration:underline; }

    /* Table */
    table { width:100%; border-collapse: collapse; }
    th, td { font-size:13px; padding:8px 10px; border-bottom:1px solid #252a33; }
    th { text-align:left; color:var(--muted); background:#131820; position: sticky; top:0; }
    .footer { color: var(--muted); font-size:12px; padding:8px 12px; background:#0b0e14; border-top:1px solid var(--border);}
    @media (max-width: 1100px) {
      .container { grid-template-columns: 1fr; }
      .rightcol { grid-template-rows: auto auto; }
      #map { height: 45vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Vehicle Dashboard</h1>
    <div id="status" class="pill">connecting…</div>
  </header>

  <div class="container">
    <!-- MAP -->
    <div class="card">
      <h2>Map</h2>
      <div id="map"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="rightcol">
      <!-- DEVICE CARDS -->
      <div class="card">
        <h2>Device Cards</h2>
        <div class="section-body">
          <div id="cards"></div>
        </div>
        <div class="footer">
          Speed color: <span class="badge spd-low">≤30</span>
          <span class="badge spd-med">31–60</span>
          <span class="badge spd-high">&gt;60</span> km/h
        </div>
      </div>

      <!-- TABLE (optional) -->
      <div class="card">
        <h2>Live Telemetry</h2>
        <div class="section-body">
          <table id="tbl">
            <thead>
              <tr>
                <th>Device</th>
                <th>Speed</th>
                <th>Movement</th>
                <th>State</th>
                <th>Lat</th>
                <th>Lon</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Map ----------
    const map = L.map('map', { zoomControl: true });
    map.setView([17.4, 78.5], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    const markers = new Map();

    function markerColor(spd) {
      if (spd == null || isNaN(spd)) return "#94a3b8";
      if (spd <= 30) return "#22c55e";
      if (spd <= 60) return "#eab308";
      return "#ef4444";
    }
    function upsertMarker(rec) {
      const { device_id, latitude, longitude, speed, movement, state, timestamp } = rec;
      const color = markerColor(speed);
      const icon = L.divIcon({
        className: "",
        html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow:0 0 6px rgba(0,0,0,.5)"></div>`,
        iconSize: [14, 14], iconAnchor: [7, 7],
      });

      let m = markers.get(device_id);
      if (!m) {
        m = L.marker([latitude, longitude], { icon }).addTo(map);
        markers.set(device_id, m);
      } else {
        m.setLatLng([latitude, longitude]);
        m.setIcon(icon);
      }
      const spdStr = (speed == null || isNaN(speed)) ? "—" : `${Math.round(speed)} km/h`;
      m.bindPopup(
        `<b>Device:</b> ${device_id}<br/>
         <b>Speed:</b> ${spdStr}<br/>
         <b>Movement:</b> ${movement ?? "—"}<br/>
         <b>State:</b> ${state ?? "—"}<br/>
         <b>Time:</b> ${timestamp}`
      );

      const latlngs = Array.from(markers.values()).map(mm => mm.getLatLng());
      if (latlngs.length === 1) map.setView(latlngs[0], 13);
      else if (latlngs.length > 1) {
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    // ---------- Helpers ----------
    function speedClass(spd) {
      if (spd == null || isNaN(spd)) return "spd-low";
      if (spd <= 30) return "spd-low";
      if (spd <= 60) return "spd-med";
      return "spd-high";
    }
    function movementClass(m) {
      if (!m) return "mv-const";
      const s = String(m).toLowerCase();
      if (s.includes("accel")) return "mv-accel";
      if (s.includes("decel")) return "mv-decel";
      return "mv-const";
    }
    function stateClass(s) {
      if (!s) return "";
      const v = String(s).toLowerCase();
      if (v.includes("move")) return "state-move";
      if (v.includes("rest")) return "state-rest";
      return "";
    }

    // ---------- Cards ----------
    const cardsEl = document.getElementById("cards");
    function renderCards(devices) {
      // Stable sort by device id
      devices.sort((a,b) => (a.device_id || "").localeCompare(b.device_id || ""));
      const frag = document.createDocumentFragment();

      for (const d of devices) {
        const spdStr = (d.speed == null || isNaN(d.speed)) ? "—" : `${Math.round(d.speed)} km/h`;
        const latStr = Number(d.latitude).toFixed(6);
        const lonStr = Number(d.longitude).toFixed(6);
        const gmaps = `https://www.google.com/maps?q=${latStr},${lonStr}`;

        const card = document.createElement("div");
        card.className = "devcard";
        card.innerHTML = `
          <div class="devhead">
            <div class="devtitle">Device ${d.device_id ?? "—"}</div>
            <button class="centerbtn" data-id="${d.device_id}">Center</button>
          </div>
          <div class="stats">
            <div class="stat">
              <div class="label">Speed</div>
              <div class="value"><span class="badge ${speedClass(d.speed)}">${spdStr}</span></div>
              <div class="sub">${d.timestamp ?? "—"}</div>
            </div>
            <div class="stat">
              <div class="label">Movement</div>
              <div class="value"><span class="badge ${movementClass(d.movement)}">${d.movement ?? "—"}</span></div>
              <div class="sub">State: <span class="badge ${stateClass(d.state)}">${d.state ?? "—"}</span></div>
            </div>
            <div class="stat">
              <div class="label">Position</div>
              <div class="value">${latStr}, ${lonStr}</div>
              <div class="coords"><a href="${gmaps}" target="_blank" rel="noopener">Open in Maps</a></div>
            </div>
          </div>
        `;
        frag.appendChild(card);
      }

      cardsEl.replaceChildren(frag);

      // Wire up "Center" buttons
      cardsEl.querySelectorAll(".centerbtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const m = markers.get(id);
          if (m) {
            map.flyTo(m.getLatLng(), 15, { duration: 0.6 });
            m.openPopup();
          }
        });
      });
    }

    // ---------- Table (kept for detail) ----------
    const rows = document.getElementById("rows");
    function renderTable(devices) {
      devices.sort((a,b) => (a.device_id || "").localeCompare(b.device_id || ""));
      rows.innerHTML = "";
      for (const d of devices) {
        const spdStr = (d.speed == null || isNaN(d.speed)) ? "—" : `${Math.round(d.speed)} km/h`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.device_id ?? "—"}</td>
          <td><span class="badge ${speedClass(d.speed)}">${spdStr}</span></td>
          <td>${d.movement ?? "—"}</td>
          <td>${d.state ?? "—"}</td>
          <td>${Number(d.latitude).toFixed(6)}</td>
          <td>${Number(d.longitude).toFixed(6)}</td>
          <td>${d.timestamp ?? "—"}</td>
        `;
        rows.appendChild(tr);
      }
    }

    // ---------- WebSocket ----------
    const status = document.getElementById("status");
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${proto}://${location.host}/ws`);

    const devices = new Map(); // device_id -> record

    function upsertDevice(rec) {
      devices.set(rec.device_id, rec);
      const list = Array.from(devices.values());
      renderCards(list);
      renderTable(list);
      upsertMarker(rec);
    }

    ws.onopen = () => status.textContent = "live";
    ws.onclose = () => status.textContent = "disconnected";
    ws.onerror = () => status.textContent = "error";

    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === "snapshot" && Array.isArray(msg.data)) {
          devices.clear();
          for (const r of msg.data) devices.set(r.device_id, r);
          const list = Array.from(devices.values());
          renderCards(list);
          renderTable(list);
          for (const r of list) upsertMarker(r);
        } else if (msg.type === "update" && msg.data) {
          upsertDevice(msg.data);
        }
      } catch (e) {
        console.error("bad message", e);
      }
    };
  </script>
</body>
</html>
